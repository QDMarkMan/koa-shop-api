# 用Koa2+mysql来做简单的服务端

## 写在前面
一直想用`koa2 + MySQL`来进行服务端的开发，就是没时间。最近终于开始了这个搁置已久的计划，这篇文章对这个过程做个简单的记录。

## 介绍
这个项目是个比较直观而且基础的项目, 用于一些中小型项目的开发或者是自己的练手是没问题。`MySQL`也采用的是非常直白的`sql`语句进行操作。主要是也想加深对`MySQL`的理解，想换成`Sequelize`的话也很简单。下面进入我们正题。

## 文件结构介绍

我这边是通过`koa-generator`创建的工程，非常的简单。希望对`koa`了解更深一点的朋友可以自己尝试着手动搭建一下，也不是很麻烦。下面是经过改造之后的文件目录结构。

```js
koa-shop-api
│   config                  // 配置文件 包括 日志/项目配置
│   middlewares             // koa中间件
│   models                  // 静态文件
│   public                  // koa2保留文件（后来会删除）
└───routes                  // API抛出曾/ controller层
│   │   index               // route自动注入文件
└───service                 // 业务逻辑层（承上启下， 操作models为controller层服务）
└───sql                     // MySQL帮助层
│   │   sql_file            // sql文件
│   │   async.js            // 数据库同步脚本文件
│   │   index.js            // MySQL 使用SQL语句
│   │   utils               // 工具类
│   │   validators          // 验证器
│   │   views               // koa2保留文件（后来会删除）
│   app.js                  // koa初始化
│   main.js                 //  项目启动文件

```

## 简化入口文件

## 增加配置文件

配置文件全部都在`config`文件夹 

这里主要是抽离了系统的配置，配置文件使用的`yaml`文件。不了解的朋友可以看一下[介绍]()

`config.dev.yaml`
```yaml
#######项目名称#######
projectName: koa-shop-api
#######备注
remark: null
#######正式/测试 production or develop
env: development
#######Node启动端口
nodeport: 3001

#######Session Key
session_key: session_id
#######Session Secret
sessionSecret: secretCat
#######Session Timeout
sessionTimeout: 30 * 60 * 1000

#######OSS配置 Start
#OSS Key
#OSS Secret
#######OSS配置 End
#########Momgo配置 Start
#########数据库配置 Start
#DB config
DB:
  host: 'localhost' # 这也是注释，不会输出的
  port: 3306
  database: 'project_progress'
  user: 'root'
  password: '123456'
#正式mongo地址
#DB_CONN_STR: 'mongodb://localhost:27017/BookPlatform'
#########数据库配置配置 End

#######Http参数 Start
#Rest链接地址 以HTTP开头

#######Http参数 End

#demokey:1

### Http通信地址的配置
#serverPath: "http://172.16.100.116:30062/"

#######请求参数配置
safe_path: "urlPath"
safe_body: "urlBody"
#######请求白名单（配置的URL不进行加密和解密）支持*，如：/ABCD/*
safe_filter_url: ['/login', '/reg']
#######安全模块配置 End
```

配置文件基本包括了我们所有的不同环境的配置，然后通过`index.js`中的`confman`进行解析。

`index.js`
```js
const confman = require('confman')

const mode = process.env.NODE_ENV === 'production' ? 'prod' : 'dev'
const configPath = `${__dirname}/config.${mode}`
const config = confman.load(configPath)
module.exports = config
```

使用方式也很简单， 直接通过引用`config`文件夹就可以引入对象形式的配置，就像下面一样。

` main.js`
```js
const config = require('./config')
// 服务端口号
const serverPort =  config.nodeport || 3000
```

## 改造自带route



